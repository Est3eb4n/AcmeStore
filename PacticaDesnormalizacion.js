db.shop.insertManyu([
    {
      "invoiceNumber": 1,
      "date": "2014-03-12T07:00:29 +05:00",
      "customer": {
        "identificationNumber": 100,
        "firstName": "Fuller",
        "lastName": "Kennedy",
        "place": {
          "address": "356 Roder Avenue",
          "city": "Marbury",
          "state": "Connecticut"
        }
      },
      "seller": {
        "identificationNumber": 100,
        "firstName": "Snider",
        "lastName": "Hale"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 190921,
          "quantity": 12
        }
      ]
    },
    {
      "invoiceNumber": 2,
      "date": "2020-04-05T12:16:27 +05:00",
      "customer": {
        "identificationNumber": 101,
        "firstName": "Gilda",
        "lastName": "Santana",
        "place": {
          "address": "876 Vernon Avenue",
          "city": "Marion",
          "state": "Puerto Rico"
        }
      },
      "seller": {
        "identificationNumber": 101,
        "firstName": "Mejia",
        "lastName": "Calderon"
      },
      "details": [
        {
          "id": 1,
          "productId": "1-0023-D",
          "price": 149541,
          "quantity": 12
        }
      ]
    },
    {
      "invoiceNumber": 3,
      "date": "2016-04-06T04:09:54 +05:00",
      "customer": {
        "identificationNumber": 102,
        "firstName": "Bush",
        "lastName": "Bernard",
        "place": {
          "address": "726 Nassau Avenue",
          "city": "Chical",
          "state": "Louisiana"
        }
      },
      "seller": {
        "identificationNumber": 102,
        "firstName": "Dora",
        "lastName": "Moses"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 44047,
          "quantity": 7
        },
        {
          "id": 2,
          "productId": "2-0023-D",
          "price": 104168,
          "quantity": 5
        },
        {
          "id": 3,
          "productId": "1-0023-D",
          "price": 241820,
          "quantity": 2
        },
        {
          "id": 4,
          "productId": "2-0023-D",
          "price": 166454,
          "quantity": 3
        }
      ]
    },
    {
      "invoiceNumber": 4,
      "date": "2014-04-07T11:25:18 +05:00",
      "customer": {
        "identificationNumber": 103,
        "firstName": "Terry",
        "lastName": "Hoover",
        "place": {
          "address": "216 Karweg Place",
          "city": "Roderfield",
          "state": "Hawaii"
        }
      },
      "seller": {
        "identificationNumber": 103,
        "firstName": "Bell",
        "lastName": "Salazar"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 57000,
          "quantity": 16
        },
        {
          "id": 2,
          "productId": "3-0023-D",
          "price": 236492,
          "quantity": 9
        },
        {
          "id": 3,
          "productId": "2-0023-D",
          "price": 151217,
          "quantity": 20
        },
        {
          "id": 4,
          "productId": "2-0023-D",
          "price": 193840,
          "quantity": 17
        }
      ]
    },
    {
      "invoiceNumber": 5,
      "date": "2019-01-21T04:36:17 +05:00",
      "customer": {
        "identificationNumber": 104,
        "firstName": "Sanders",
        "lastName": "Fernandez",
        "place": {
          "address": "668 Dumont Avenue",
          "city": "Stewart",
          "state": "Alaska"
        }
      },
      "seller": {
        "identificationNumber": 104,
        "firstName": "Cunningham",
        "lastName": "Mccullough"
      },
      "details": [
        {
          "id": 1,
          "productId": "5-0023-D",
          "price": 69691,
          "quantity": 7
        },
        {
          "id": 2,
          "productId": "2-0023-D",
          "price": 238886,
          "quantity": 10
        },
        {
          "id": 3,
          "productId": "2-0023-D",
          "price": 142856,
          "quantity": 2
        }
      ]
    },
    {
      "invoiceNumber": 6,
      "date": "2022-05-30T08:10:04 +05:00",
      "customer": {
        "identificationNumber": 105,
        "firstName": "Dorthy",
        "lastName": "Bishop",
        "place": {
          "address": "693 Liberty Avenue",
          "city": "Kilbourne",
          "state": "Ohio"
        }
      },
      "seller": {
        "identificationNumber": 105,
        "firstName": "Park",
        "lastName": "Slater"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 31191,
          "quantity": 19
        },
        {
          "id": 2,
          "productId": "2-0023-D",
          "price": 73345,
          "quantity": 14
        },
        {
          "id": 3,
          "productId": "2-0023-D",
          "price": 167499,
          "quantity": 14
        },
        {
          "id": 4,
          "productId": "2-0023-D",
          "price": 48705,
          "quantity": 8
        }
      ]
    },
    {
      "invoiceNumber": 7,
      "date": "2018-01-25T09:49:03 +05:00",
      "customer": {
        "identificationNumber": 106,
        "firstName": "Villarreal",
        "lastName": "Glenn",
        "place": {
          "address": "463 Jodie Court",
          "city": "Alamo",
          "state": "California"
        }
      },
      "seller": {
        "identificationNumber": 106,
        "firstName": "Meghan",
        "lastName": "Bradford"
      },
      "details": [
        {
          "id": 1,
          "productId": "5-0023-D",
          "price": 230949,
          "quantity": 5
        },
        {
          "id": 2,
          "productId": "1-0023-D",
          "price": 226865,
          "quantity": 3
        },
        {
          "id": 3,
          "productId": "5-0023-D",
          "price": 201196,
          "quantity": 17
        }
      ]
    },
    {
      "invoiceNumber": 8,
      "date": "2015-12-21T07:06:04 +05:00",
      "customer": {
        "identificationNumber": 107,
        "firstName": "Jennifer",
        "lastName": "Richmond",
        "place": {
          "address": "724 Ross Street",
          "city": "Manchester",
          "state": "Federated States Of Micronesia"
        }
      },
      "seller": {
        "identificationNumber": 107,
        "firstName": "Calhoun",
        "lastName": "Sears"
      },
      "details": [
        {
          "id": 1,
          "productId": "2-0023-D",
          "price": 27085,
          "quantity": 1
        },
        {
          "id": 2,
          "productId": "5-0023-D",
          "price": 62805,
          "quantity": 7
        }
      ]
    },
    {
      "invoiceNumber": 9,
      "date": "2023-12-02T01:15:36 +05:00",
      "customer": {
        "identificationNumber": 108,
        "firstName": "Knight",
        "lastName": "Smith",
        "place": {
          "address": "661 Fay Court",
          "city": "Ticonderoga",
          "state": "Oregon"
        }
      },
      "seller": {
        "identificationNumber": 108,
        "firstName": "Velasquez",
        "lastName": "Wiggins"
      },
      "details": [
        {
          "id": 1,
          "productId": "5-0023-D",
          "price": 132615,
          "quantity": 16
        },
        {
          "id": 2,
          "productId": "5-0023-D",
          "price": 172732,
          "quantity": 9
        }
      ]
    },
    {
      "invoiceNumber": 10,
      "date": "2023-02-07T08:54:31 +05:00",
      "customer": {
        "identificationNumber": 109,
        "firstName": "Ericka",
        "lastName": "Cantrell",
        "place": {
          "address": "411 Lefferts Place",
          "city": "Orason",
          "state": "Indiana"
        }
      },
      "seller": {
        "identificationNumber": 109,
        "firstName": "Margaret",
        "lastName": "Luna"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 140732,
          "quantity": 8
        },
        {
          "id": 2,
          "productId": "5-0023-D",
          "price": 31033,
          "quantity": 13
        }
      ]
    },
    {
      "invoiceNumber": 11,
      "date": "2023-12-30T08:50:31 +05:00",
      "customer": {
        "identificationNumber": 110,
        "firstName": "Carroll",
        "lastName": "Lindsay",
        "place": {
          "address": "334 Lott Street",
          "city": "Cliffside",
          "state": "Michigan"
        }
      },
      "seller": {
        "identificationNumber": 110,
        "firstName": "Alexis",
        "lastName": "Park"
      },
      "details": [
        {
          "id": 1,
          "productId": "2-0023-D",
          "price": 90731,
          "quantity": 10
        },
        {
          "id": 2,
          "productId": "3-0023-D",
          "price": 34096,
          "quantity": 20
        }
      ]
    },
    {
      "invoiceNumber": 12,
      "date": "2022-10-21T12:06:07 +05:00",
      "customer": {
        "identificationNumber": 111,
        "firstName": "Lorena",
        "lastName": "Hebert",
        "place": {
          "address": "927 Bushwick Court",
          "city": "Nicholson",
          "state": "Arkansas"
        }
      },
      "seller": {
        "identificationNumber": 111,
        "firstName": "Booth",
        "lastName": "Bentley"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 87279,
          "quantity": 2
        },
        {
          "id": 2,
          "productId": "2-0023-D",
          "price": 42066,
          "quantity": 16
        },
        {
          "id": 3,
          "productId": "2-0023-D",
          "price": 69759,
          "quantity": 12
        },
        {
          "id": 4,
          "productId": "2-0023-D",
          "price": 238840,
          "quantity": 12
        }
      ]
    },
    {
      "invoiceNumber": 13,
      "date": "2020-04-13T08:27:28 +05:00",
      "customer": {
        "identificationNumber": 112,
        "firstName": "Frances",
        "lastName": "Stewart",
        "place": {
          "address": "284 Pilling Street",
          "city": "Glendale",
          "state": "Northern Mariana Islands"
        }
      },
      "seller": {
        "identificationNumber": 112,
        "firstName": "Aguilar",
        "lastName": "Jennings"
      },
      "details": [
        {
          "id": 1,
          "productId": "2-0023-D",
          "price": 97887,
          "quantity": 4
        },
        {
          "id": 2,
          "productId": "5-0023-D",
          "price": 43136,
          "quantity": 18
        }
      ]
    },
    {
      "invoiceNumber": 14,
      "date": "2022-01-27T03:28:27 +05:00",
      "customer": {
        "identificationNumber": 113,
        "firstName": "Latisha",
        "lastName": "Walters",
        "place": {
          "address": "116 Jackson Court",
          "city": "Kiskimere",
          "state": "New Mexico"
        }
      },
      "seller": {
        "identificationNumber": 113,
        "firstName": "Mullen",
        "lastName": "Pate"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 150066,
          "quantity": 7
        },
        {
          "id": 2,
          "productId": "5-0023-D",
          "price": 105546,
          "quantity": 12
        }
      ]
    },
    {
      "invoiceNumber": 15,
      "date": "2024-01-15T04:02:45 +05:00",
      "customer": {
        "identificationNumber": 114,
        "firstName": "Fulton",
        "lastName": "Palmer",
        "place": {
          "address": "210 Rutland Road",
          "city": "Yardville",
          "state": "Wisconsin"
        }
      },
      "seller": {
        "identificationNumber": 114,
        "firstName": "Hunter",
        "lastName": "Watts"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 53887,
          "quantity": 12
        },
        {
          "id": 2,
          "productId": "5-0023-D",
          "price": 198953,
          "quantity": 6
        }
      ]
    },
    {
      "invoiceNumber": 16,
      "date": "2023-10-09T12:08:44 +05:00",
      "customer": {
        "identificationNumber": 115,
        "firstName": "Cross",
        "lastName": "Avery",
        "place": {
          "address": "378 Oakland Place",
          "city": "Roberts",
          "state": "Mississippi"
        }
      },
      "seller": {
        "identificationNumber": 115,
        "firstName": "Collins",
        "lastName": "Berg"
      },
      "details": [
        {
          "id": 1,
          "productId": "5-0023-D",
          "price": 184551,
          "quantity": 2
        },
        {
          "id": 2,
          "productId": "2-0023-D",
          "price": 82854,
          "quantity": 16
        },
        {
          "id": 3,
          "productId": "2-0023-D",
          "price": 211005,
          "quantity": 18
        },
        {
          "id": 4,
          "productId": "5-0023-D",
          "price": 159857,
          "quantity": 3
        }
      ]
    },
    {
      "invoiceNumber": 17,
      "date": "2019-12-11T01:19:39 +05:00",
      "customer": {
        "identificationNumber": 116,
        "firstName": "Joyce",
        "lastName": "Herring",
        "place": {
          "address": "447 Etna Street",
          "city": "Thornport",
          "state": "Palau"
        }
      },
      "seller": {
        "identificationNumber": 116,
        "firstName": "Leon",
        "lastName": "Hayden"
      },
      "details": [
        {
          "id": 1,
          "productId": "2-0023-D",
          "price": 162751,
          "quantity": 16
        },
        {
          "id": 2,
          "productId": "3-0023-D",
          "price": 137129,
          "quantity": 13
        },
        {
          "id": 3,
          "productId": "5-0023-D",
          "price": 138548,
          "quantity": 13
        }
      ]
    },
    {
      "invoiceNumber": 18,
      "date": "2022-07-06T07:16:35 +05:00",
      "customer": {
        "identificationNumber": 117,
        "firstName": "Sharlene",
        "lastName": "Cohen",
        "place": {
          "address": "727 Chapel Street",
          "city": "Summerset",
          "state": "Virgin Islands"
        }
      },
      "seller": {
        "identificationNumber": 117,
        "firstName": "Bauer",
        "lastName": "Kent"
      },
      "details": [
        {
          "id": 1,
          "productId": "3-0023-D",
          "price": 115425,
          "quantity": 19
        }
      ]
    },
    {
      "invoiceNumber": 19,
      "date": "2014-09-25T10:12:14 +05:00",
      "customer": {
        "identificationNumber": 118,
        "firstName": "Lakisha",
        "lastName": "Russell",
        "place": {
          "address": "164 Douglass Street",
          "city": "Sidman",
          "state": "Nevada"
        }
      },
      "seller": {
        "identificationNumber": 118,
        "firstName": "Leticia",
        "lastName": "Mcdowell"
      },
      "details": [
        {
          "id": 1,
          "productId": "5-0023-D",
          "price": 36492,
          "quantity": 16
        },
        {
          "id": 2,
          "productId": "2-0023-D",
          "price": 236697,
          "quantity": 2
        },
        {
          "id": 3,
          "productId": "2-0023-D",
          "price": 194375,
          "quantity": 12
        }
      ]
    },
    {
      "invoiceNumber": 20,
      "date": "2015-03-06T06:13:57 +05:00",
      "customer": {
        "identificationNumber": 119,
        "firstName": "Mccall",
        "lastName": "Acosta",
        "place": {
          "address": "795 Fleet Place",
          "city": "Austinburg",
          "state": "Maine"
        }
      },
      "seller": {
        "identificationNumber": 119,
        "firstName": "Heidi",
        "lastName": "Curry"
      },
      "details": [
        {
          "id": 1,
          "productId": "2-0023-D",
          "price": 108501,
          "quantity": 14
        },
        {
          "id": 2,
          "productId": "3-0023-D",
          "price": 181878,
          "quantity": 15
        },
        {
          "id": 3,
          "productId": "3-0023-D",
          "price": 186524,
          "quantity": 20
        }
      ]
    }
  ])

db.createColletion('shop',
    {
        validator: {
            $jsonSchema: {
                bsonType: 'object',
                required: ['customer'
                ],
                properties: {
                    customer: {
                        bsonType: 'object',
                        properties: {
                            identificationNumber: {
                                bsonType: "number",
                            },
                            firstName: {
                                bsonType: "string"
                            },
                            lastName: {
                                bsonType: "string"
                            },
                            place: {
                                bsonType: 'object',
                                properties: {
                                    bsonType: "string",
                                    address: {
                                        bsonTipe: "string"
                                    },
                                    city: {
                                        bsonType: "string"
                                    },
                                    state: {
                                        bsonType: "string"
                                    }
                                }
                            }
                        }
                    },
                    seler: {
                        bsonType: "object",
                        properties: {
                            bsonType: "string",
                            identificationNumber: {
                                bsonType: "string"
                            },
                            firstName: {
                                bsonType: "string"
                            },
                            lastName: {
                                bsonType: "string"
                            }
                        }
                    },
                    details: {
                        bsonType: "object",
                        properties: {
                            bsonType: "string",
                            itemNumber: {
                                bsonType: "number"
                            },
                            ProductID: {
                                bsonType: "string"
                            },
                            price: {
                                bsonType: "number"
                            },
                            quantity: {
                                bsonType: "number"
                            },
                            observation: {
                                bsonType: "string"
                            }
                        }
                    }
                }
            }
        }
    })



[
    {$match:{invoiceNumber:"1"}},
    {
        $lookup:{
            from:"products",
            localField:"details.productID",
            foreignField:"code",
            as:"details.products"
        }
    },
    {$addFields:{"details.total":{$multiply:["$details.quantity","details.price"]}}},
    {
        $project:{
            "details.productId":0,
            "details.product.price":0,
            "details.product._id":0
        }
    },
    {
        $group:{
            _id:// incorporar producto
        }
    }
]